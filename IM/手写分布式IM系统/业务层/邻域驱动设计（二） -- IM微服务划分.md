## 背景分析
plato是一个完整的IM解决方案，我们已经确定了整体的长连接接入层的技术方案但对业务却了解甚少，为了能得到在业务，技术，管理三个维度都做到优雅的技术方案，我们需要进行IM业务层的微服务的划分，规划出plato的业务架构图。
plato的最终意义是，实现一个人能够从0到1落地的复杂度最高的IM系统。

## 设计目标
我们期望，实现IM的基本功能如下：
1. 单聊/群聊/聊关室/多设备登陆/在线状态
2. 文本消息/多媒体消息/离线同步/历史消息/消息漫游
3. 多端同步/消息撤回/已读未读/离线推送 
4. 添加好发/会话列表/好发列表

## 评估标准
1.技术角度看
	a.整体通信复杂度降低，RPC调用次数可以收敛 
	b.关键接口满足**延迟，吞吐，可用**等要求指标约束 
	c.兼顾长短期自标，短期敏捷送代，长期整洁架构 
	d.便于快速发现/定位/修复问题的可维护&可观测性
2 .业务角度看，实现上述产品功能，面向业务需求可扩展
	a.反复同类需求可配置化具自动化，可沉淀到运营&产品平台进行自助解决 
	b.便于数据分析，提供实时&近线&离线数据的快速且灵活查询
3.管理角度看
	a.保证交付需求的质量，上线后不会引入新问题，达成预期
	b.保证需求如期交付，技术人员的需求负载均衡，且高吞吐低延迟的交付需求 
	c.应对人员流动，每个模块都要有buckup，并且保证新人快速接手
	d.合理划分技术团队职责，保证协作沟通效率，分离关注点与责任范围

## 解决方案
> 使用**DDD-战略设计**，设计一个满足目标的系统

| 方案                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            | 收益                                                                                                                                                                                                                                            | 代价                                                                                                                                                                                |
| ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 事件风暴<br>![](063beff7a331d38faa82dd973888738d_MD5.jpeg)<br>命令风暴<br>![](e42a7930f8b33d851316b8679cbffde9_MD5.jpeg)<br>聚合及聚合根<br>![](879fa6b0e3aa66177863c2972f24b4d7_MD5.jpeg)<br>划分界限上下文<br>![](073cbcc60816068b2885808f01441b41_MD5.jpeg)<br>1. 拆分**用户服务user server**，用于管理用户信息与权限<br>2. 拆分**关系服务relation server**，用于管理用户关系链及链上的权限，信息，数据。 <br>3. 拆分**消息服务message server**，用于管理消息维度的权限，信息，存储等工作。 <br>4. 上述三者为领域服务，对外暴露一个应用服务**API Server，业务适配与需求交付**。 <br>5. 抽象一个common包封装所有基础设施的依赖接口，实现依赖倒置<br>a.领域层仅依赖接口而非基础设施的具体实现<br>b.所有服务均使用相同的common包来操作基础设施层<br>c.只有抽象出领域服务，确定核心域才能形成真正的业务资产<br>![](21350b9ca50780177d5ee67ee00a6eac_MD5.jpeg) | 1. 每个服务都是**最小完备**的，所谓最小完备就是未来可以发展为一个独立中台的能力<br>2. 每个子领域内的研发仅关注自身业务即可，关注点分离，职责明确<br>3. 便于技术团队的人才建设，每个子领域配备一个资深两个高级，以及若干应届 <br>4. 每个子域的技术团队自行调节需求的负载，充分发挥每个研发的技术能力<br>5. 每个子域的需求皆可独立完成，尽可能降低跨子域需求的数量<br>6. 即使存在跨子域需求也可以通过对外提供的API Server最终聚合而实现 | 1. 需要进行多次RPC <br>2. 没有解决基础设施依赖问题<br>3. 为考虑数据分析和同质化需求的配置化<br>4. 为给出具体功能的实现细节，因此无法评估其是否适用于技术评估标准<br>5. 需要额外的心智负担来理解复杂庞大的common包逻辑<br>6. 需要额外的关注，确定common包的逻辑边界，不能将与业务相关的代码写入common包 |
|                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |                                                                                                                                                                                                                                               |                                                                                                                                                                                   |
逐一分析业务功能的实现

| 方案                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | 收益                                                                                        | 代价                                                                                                                                                                                                                                                                                                                                         |
| -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| ==单聊==<br>1. 上行消息，api server直接调用msg server将消息异步存储，二者可以通过MQ交互<br>2. 下行消息，api server根据to user id字段确定发送给哪个user，调用user server拿到用户信息，然后打包为下行消息发送给接入层即可<br>==群聊==<br>直接调用relation server查询sessionlD下除自身之外的did List然后逐条打包下行消息，交给接入层即可<br>==多设备登录/同步==<br>1. 接入层通知api server userID下的此DID已经登陆，然后api server将其userlD与DID的关系注册到关系链服务<br>2. 当发送下行消息时，api server查询userlD的时候，会返回其下游的多个did list，然后打包为多个下行消息，发送给接入层<br>3. 需要做一个user ID的did设备的数量限制<br>==在线状态==<br>1. 接入层在某个用户创建连接登陆上线时，通知api server<br>2. Api server会查询relation server找到全部的好友列表，将上线状态全部推送出去<br>==多媒体消息==<br>1. 客户端上传时，先上传云存储服务，然后将返回的url上传im<br>2. im需要定义一种多媒体消息类型，用来后续的业务拓展<br>==消息漫游 拉取历史 离线推送==<br>1. 客户端使用http接口拉取消息会话的历史消息<br>2. 提供拉取一批session的消息，每个session携带seqID<br>3. 通过客户端返回最大的seqID获取最近20条的消息并显示离线期间还有多少条记录未拉取<br>4. 基于seqlD作为offset反复拉取<br>==消息撤回==<br>1. 发送者对某个消息撤回时，给接入层发送消息撤回信令<br>2. APl server会给消息打上删除标记，然后推送给会话所有人，使其在客户端内制除<br>3. 并保证直接修改消息的离线缓存，确保拉取历史时不会有被撤回的消息已读/未读<br>==已读/未读==<br>1. 客户端主动上报可读事件，可以通过http接口上报来减轻长连接网关的带宽 <br>2. 接入层维护一个已读列表，push给当前会话内容其他人，更新已读未读状态<br>==添加好友/会话列表/好友列表==<br>1. Api server操作relation server增加好友关系，当一个客户第一次聊天时创建session。 <br>2. 客户端启动时会去拉取会话列表，好友列表，都存储在relation server中<br>![](1090f6fca395eb84204d2e7c65470e3d_MD5.jpeg) | 1. 实现简单，上线送代<br>2. DAU在百万以内均可满足架构要求<br>3. 当前微服务完全可以完成上述所有业务需                              | 1. 群聊过大时，session下查出过多did，会造成**消息风暴**<br>2. 在线状态：如果用户好友众多，那么登陆状态的推送将造成消息风暴，弱网情况频繁掉线，会造成状态频繁推送<br>3. 多媒体上传存在安全黑产风险，其次就是二进制文件的重复存储成本<br>4. 拉取**历史消息**，如何运行拉取历史所有，那需要极高的存储成本<br>5. 消息撤回，在群聊场景下消息撤回依旧存在消息风暴的问题，并且修改离线消息时，可能存在并发冲突等一致性问题<br>6. 已读事件的传播过于频繁，如何保证低延迟和一致性问题是一个技术挑战<br>7. Relation server需要存储关系链及其数据，会消耗过多的存储要保证其可靠性和低延迟，单体服务技术成本过大。 |
| Relationserver承载着技术挑战，根据通信的复杂度可以将relation拆解为 会话/关系 两个服务<br>1. 提供对会话的增删改查操作，并提供查询一个用户拥有的会话或者会话下拥有的用户，用户下的设备ID等。<br>2. 关系服务提供对用户关系的增删操作，维护用户与用户设备之间的存储关系，提供查询用户好友列表，设备列表                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               | 除考虑了业务因素，还考虑到了技术因素，使其通信复杂度降低。                                                             | Relation server的定位比较模糊，不是一个具象的概念                                                                                                                                                                                                                                                                                                           |
| 对用户信息的查询和用户关系的查询通常一起出现，没必要分成两个服务，因此可以将其合并在一起。<br>重新定义user server的职责，负责查询用户信息，用户关系，以及用户与设备的关系。<br>![](c8674c1724d8d01a9988f7658553d1b2_MD5.jpeg)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | 用户，消息，会适三个上下文均是各自完备的。<br>用户可以发展为用户中台。<br>消息可以发展为消息中台，**直播，弹幕，im，推送**。<br>会话属于消息中台的通用子域存在。 |                                                                                                                                                                                                                                                                                                                                            |
|                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |                                                                                           |                                                                                                                                                                                                                                                                                                                                            |
## 添加约束
如何满足业务产品的演进诉求？

| 方案                                                                                                                                                                                                                                                                                                                                                                        | 收益                                            | 代价  |
| ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------- | --- |
| 1. 独立创建一个console server，用来对外承载web ui对外接口调用<br>2. 一个config server作为整体的业务配置化管理中心 <br>3. 创建一个报表引擎服务，用来做IM的数据分析<br>4. 提供自动化接入能力，提供IM SDK自动分配appID/bizID，自动创建服务集<br>群，对外提供saas api能力<br>5. 对外多租户鉴权，功能分级管理，对外输出控制台能力，可运营配置化，形成IM Saas产品。<br>![](9f826b5ca813ff86c7267d2283d8fe00_MD5.jpeg) | 1. 业务形态遂一演进，成为独立产品<br>2. 符合技术演进的基本规律，**多快好省** |     |

如何划分服务可以满足技术管理的诉求？

| 方案                                                                                                                                                                                                                                                                                                                                                                                                                             | 收益                                                    | 代价                                                                   |
| ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | ----------------------------------------------------- | -------------------------------------------------------------------- |
| 1. 各自开发一个server，有需求一起做，if else满天飞<br>2. 每个需求上线一个日志，监控，报警<br>3. 每次需要自己想办法在开发机上做测试，重复构建测试环境<br>4. 面对产品需求，给一个排期就开始做，需求仅考虑短期目标<br>5. 下游基础设施遇到问题再迁移，否则从不做技术重构<br>6. 需要什么服务就直接调用sdk继承过来就好<br>7. 代码相互敷衍式review                                                                                                                                                                                                                        | 1. 小规模业务，快速上线，敏捷开发<br>2. 三到五人团队无管理成本，完全靠研发的自觉         | 1. 职责目标不明确 <br>2. 频繁出现线上事故 <br>3. 需求交付总延期<br>4. 架构逐渐臃肿，代码难以阅读，项目难以维护 |
| 招聘足够牛的人，整治和管理项目，一个资深带多个高级和应届重构系统。<br>1. 业务抽象，解决if else问题，做到业务和运行时隔离 <br>2. 引入专门的devops角色，保证系统稳定性<br>3. 强制规范化，研发，测试，上线，处理流程<br>4. 开始注重配置化与自动化重复的运维等工作                                                                                                                                                                                                                                                                           | 1. 绝大多数的中型公司，所达到的管理状态<br>2. 可以保持自身业务的在高速增长下的业务&管理上的权衡 | 1. 这一阶段的架构，没有给技术需求留下足够的发展空间<br>2. 没有关注全局性的系统依赖问题，可能导致未服务划分混乱，过粗或过细   |
| 1. 拆解**消息，用户，会话**三个界限上下文，垂直需求可独立完成，横向需求可闭环 <br>2. **持续优化运行时** 监控&报警&日志&巡检，确保有效性：**误报/漏报/及时/区分度**<br>3. **打造高效稳定的测试环境**：研发&预览&生产泳道模式提高测试效率确保交付质量<br>4. **交付需求交由API Server团队负责**，直接与产品对接，支持产品需求落地<br>5. 基础设施团队提供技术支持，领域服务通过**依赖倒置**原则，屏蔽实现细节<br>6. 核心逻辑收敛于算子函数通过配置可插拔，基于DAG做业务编排，基于事件消息驱动<br>![](554765fc4169230846ba7f12910fda74_MD5.jpeg) | 在整洁架构上优雅开发                                            |                                                                      |

