**长连接网关的中台演化**
在商业公司中，有限的资源（时间&人力）下要求我们高效率的进行开发送代，提高效率本质上就是仅做必要的事情，为了使研发资源最大程度的复用，大型公司建设起了中台项目，拆解出基础能力横向支持所有业务线的产品，缩短一个产品的上线周期，提高人效。而对于长连接网关，在具有众多产品矩阵的中大型公司，都会演进为消息中台。在这里面，所面对的技术挑战，是**动态变化的需求与通用架构的矛盾**
消息系统，必须抽象出一套良好的领域模型，以便于应对不确定的需求选代，并保证自身的技术目标。

## 1. 长连接服务如何做到通用性，灵活对接各种业务场景？

| 方案                                                                                                                                                                                                                                                                                                                                                                         | 收益                                                                                                                                    | 代价                                                                                       |
| -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------- |
| ==APP ID做逻辑区分==<br>1. 使用app id作为不同业务方的区分标示 <br>2. 不同的app id在区分不同的代码逻辑<br>3. 不同的app id也部署在不同的集群，进行资源隔离                                                                                                                                                                                                                                                                      | 实现简单，容易理解                                                                                                                             | 1. 随着业务的增多会逐渐复杂化 <br>2. 没做领域建模，代码不能复用                                                    |
| ==发布，订阅模式==<br>> 阅读：[长连接网关技术专题(二)：知乎千万级并发的高性能长连接网关技术实践-网络编程/专项技术区 - 即时通讯开发者社区!](http://www.52im.net/thread-2737-1-1.html)<br>1. 进行领域建模抽象，将网关整体比作消息通道<br>2. 订阅者和消费者可以多对多组合，灵活处理业务逻辑 <br>3. 数据-上报，广播，通讯等场景都可以适用<br>4. 不同的场景，分不同的集群，接入不同域名下ip config server <br>5. 其中通信可以根据Qos进行策略分级<br>6. 通过token机制做到业务角色的权限隔离，在gateway做acl鉴权<br>7. Token由ip config动态下发 <br>8. 也必须做资源上的运行时隔离 | 1. 可以灵活组合，消费者和生产者，支持各种业务 <br>2. 较高的抽象，可以实现代码复用，实现中台化                                                                                  | 1. 业务抽象程度较高，理解成本高<br>2. 对代码高复用度的要求，是否符合当前业务发展需要进行一定的权衡                                   |
| ==单元化部署方案==<br>1. Ip config+gateway+state server形成小集群<br>2. 由ops server管理集群，每个业务一个集群(支持混合&独占)<br>3. State Server实现pipeline + config可插拨式配置，由业务自己组合，处理逻辑                                                                                                                                                                                                                     | 1. 对当前代码改动较小，可以具备足够的扩展性<br>2. Pipeline保证了代码的复用性，具备了中台化能力 <br>3. 可灵活组合复用代码框架<br>4. 资源与业务完全隔离部署，可靠性大大提高<br>5. 统一opsserver调度，提高了机器资源的利用率 | 1. 需要提供足够的接入&使用文档，避免用户关注代码逻辅而忽略业务领域<br>2. 不同业务形态，其分发逻辑有很大不<br>同，写放大会面对存储和一致性问题，读放大会影响延迟。 |
| ==session绑定==<br>1. 由于分发逻辑对于不同业务场景，有很大的差异性，没有通用方案 <br>2. 所以，将分发逻辑作为一种策略机制，交由业务方自行实现<br>3. 接入层提供给业务层一个回调RPC，用来让客户自行决定在何时将哪些did与session绑定，同时包含update操作。<br>4. 针对广播通讯和点对点通信，分别采用吞吐优先和延迟优先的两种设计<br>5. 网关机会将session到did的映射写入本地内存，以使于基于session进行查找分发 <br>6. 业务层要感知连接断开和创建事件以便于发现session中在线did的变化作出策略                                                                             | 1. 解决分发逻辑不统一的问题<br>2. 兼顾群聊和c2c聊天的不同目标                                                                                                 | 1. 业务server要感知网关层的状态<br>2. 要较为复杂的维护session映射状态                                           |

![](IM/%E6%89%8B%E5%86%99%E5%88%86%E5%B8%83%E5%BC%8FIM%E7%B3%BB%E7%BB%9F/%E6%8E%A5%E5%85%A5%E5%B1%82/attachments/56c308ad1059a4fa7bcd1cf71bca58ec_MD5.jpeg)

## 2. 如何多数据中心部署长连接网关？
对于接入层最大的问题，在于跨广域网的下行消息下发。

| 方案                                                                                                                                                 | 收益                                                                  | 代价                                                                                |
| -------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------- | --------------------------------------------------------------------------------- |
| ==基于连接调度器，降低下行消息的广域请求==<br>基于地理信息，社交关系，计算活跃会话关系，通过ip config server服务下发的ip列表，将通信最频繁的用户尽可能的放在一个数据中心，减少广域请求的数量                                        | 广域请求数量达到最低，整体下行消息p99降低                                              | 1. 如果读conf所在数据中心异常，整体服务将不可用 <br>2. 用户关系变化迅速，近/离线计算统计数据存在延近 <br>3. 实现起来较为复杂，技术上有困难 |
| ==旁路化==<br>1. 将ip config server部署在独立的数据中心或者提供多数据中心热备集群 <br>2. 来防止由于获取ip地址的路径失败，造成整个接入层不可用，出现p0事故                                                   | 提高了整个而接入层的可用性                                                       | 1. 多数据中心部署ip conf server成本升高<br>2. 热备机数据变化延迟更大，计算结果误差率增大                          |
| ==建设下行消息专线+MQ==<br>1. 路由信息交给中心化存储服务维护，存储服务会负责多数据中心的数据同步问题 <br>2. did到endpoint的映射会同步到多个机房，endpoint中增加机房标示<br>3. 在下行消息分发时，如果这是一个跨机房的下发，则通过跨机房的专属MQ分发 | 1. 使用MQ通信，双方对跨机房的通信无感知<br>2. 网络专线，降低广域网络传输延迟 <br>3. 对整体架构改造最小，扩展性极好 | 专线搭建增加成本，也可选择用公网进行MQ传输                                                            |
![](IM/%E6%89%8B%E5%86%99%E5%88%86%E5%B8%83%E5%BC%8FIM%E7%B3%BB%E7%BB%9F/%E6%8E%A5%E5%85%A5%E5%B1%82/attachments/53d89a4976578071bef6fa7a8ecc29d8_MD5.jpeg)

## 3. 方案总结
**整体分为三个服务**
1. ip config server 实现连接的调度服务
2. gateway 持有长连接socket状态的服务
3. state server 接入层消息协议&分发策略服务

其中，有一个ops server 是一个横向服务，跨越接入、业务、存储层 做同一的运维任务调度管理。
![](IM/%E6%89%8B%E5%86%99%E5%88%86%E5%B8%83%E5%BC%8FIM%E7%B3%BB%E7%BB%9F/%E6%8E%A5%E5%85%A5%E5%B1%82/attachments/1d470e73e0a6b052ffe917512e6fe064_MD5.jpeg)
![](IM/%E6%89%8B%E5%86%99%E5%88%86%E5%B8%83%E5%BC%8FIM%E7%B3%BB%E7%BB%9F/%E6%8E%A5%E5%85%A5%E5%B1%82/attachments/f80634dc300dd71283082f2327e81d31_MD5.jpeg)

### 1. 连接发现

>1.客户端连接时先通过域名查找到ip config server服务
>2.该conf服务会通过服务发现监听到长连接网关的endpoint地址信息
>3.每次查询时依据其监听到的当前时刻的指标数据，实时计算出排序每个网关机ip的排序分值 
>4.然后返回其中的top8给到客户端
### 2. 连接注册

>1.客户端初始化时，通过IP conf服务拿到一批可接入的ip列表。
>2.通常选择第一个ip进行接入，发起tcp连接握手，并发送连接注册信令。
>3.网关机接到socket的创建事件，将其fd注册到reactor的epoll上并注册监听socket读事件。 
>4.网关机创建一个conn对象，每个conn对象返辑上都有一个connlD是did+fd的int64，但在内存中维护一个did到conn对象列表的映射即可。
>5.然后将消息转发给state server，state server识别这是接入层内部的连接注册信令。 
>6.State server会存储did到endpoint的映射关系。
>7.State server给业务server发送一个rpc，用来通知业务server该用户上线。
>8.启动一个连接超时计时器，告知网关机创建成功，网关机回复客户端，连接创建成功
### 3.上行消息

> 1.客户端将消息发送给网关机，网关机解析消息的固定头
> 2.将消息的可变头和消息体转发给state server，识别出这是一个上行消息
> 3.负载均衡到下游的一个业务server上，业务server完成异步存储后返回确认消息
### 4.下行消息

> 1.如果session是大规模的群聊则使用MQ发送下行消息
> 2.如果session是点对点聊天或者是小群聊场景则使用RPC发送消息
> 3.如果使用MQ，所有的state server皆在一个group中，保持仅被消费一次
> 	a. 然后做群聊的优化分发的一些策路，启动飞行重传计时器，写入到另一个MQ中
> 	b.网关机全部监听此MQ，每个网关机独立一个group，保证重复消费此信息
> 	c.网关机检查该消息所标明的did，是否在自己的路由表内，是的话分发否则忽略
> 	d.如果该消息to_did_list字为空，则查找sessionlD是否在本机内存中，是则遍历其中的did进行分发
> 4.如果使用RPC，只有某个state server会接到消息
> 	a.业务server会根据session查到userlD list，再扇出查询到did list 
> 	b.然后打包下行消息体，其中携带did list作为路由
> 	c.State server根据did信息查询endpoint信息，然后发起RPC调用将消息交给网关机 
> 	d.网关机根据did路由到conn对象，将消息下发给客户端
> 	e.如果to_did_list为空，则查找sessionlD是否在本地维护，是则遍历其中did进行消息分发 
> 5.无论上述哪一种模式，state server发送消息后都会启动一个重传计时器，将消息加入飞行队列。
> 6.客户端回复ack后，将ack消息转发给任意state服务state删除除飞行队列中的消息并取消重传计时。

### 5.session绑定

> 1.业务方可根据群聊/聊天室的规模活跃程度来确定是否要建设session绑定，加速分发速度。
> 2.业务方根据业务特点在合适的时机（例如创建连接/加入聊天室）回调state server session 绑定rpc
> 3.输入给state server： did->sessionlD list的映射
> 4.State server会根据此信息建立sessionlD到did list的倒排，并根据endpoint进行归类同步给网关机
> 5.网关机在本地内存中构建session到部分did list的倒排结构
> 6.在业务server下发群聊/聊天室消息时，直接下发sessionlD，state server会直接通过MQ将消息分发给所有网关机，网关机会从本地内存中找到该session下的did list，遍历conn对象将消息下发下去。
> 7.使用session绑定策略后，需要在连接注册时给业务server发送一个rpc进行回调。

### 6.断线重连

> 1.网关机发现epoll返回连接断开事件，启动一个重连计时器
> 2.客户端重新连接后，创建新的socket对象，然后根据其did确定conn对象是否存在
> 3.如果存在说明重连成功，取消重连计时器，否则计时器超时，通知state server回收状态

### 7.平滑重启
[黑科技解密！实现socket进程间迁移！](https://zhuanlan.zhihu.com/p/405620115)
> 1.新网关机占用其他端口，在服务发现层是一个新的endpoint
> 2.旧网关机创建一个unix domain socket新网关机根据名称监听此socket
> 3.旧网关机通过unix domain socket先将listen fd发送给新网关机，并在本地close不再接受新连接
> 4.旧网关机遍历did到conn的map对象，逐一序列化后发送给新网关机
> 5.旧网关机反序列化好后，重新建立映射关系（conn对象中维护sessionlD的列表，用来构建session映射)
> 6.旧网关通过unix domain socket发送dup(clientfd)给新网关机，要处理好发送过程中的并发问题

### 8.连接迁移

> 1.Ops server查询中心存储，确定要迁移的did有哪些
> 2.逐个找到对应该did所在的网关机，发起rpc请求将其迁移到目标网关机上
> 3.旧网关机给客户端发起重定向信令，客户端按重定向要求与新网关机建立连
> 4.并回复旧网关机连接注册完毕，客户端知其为新连接，不会接收此连接上的消息以及发消息
> 5.旧网关机接收到新连接已经建立的消息后，自动断开连接并回收连接资源 
> 6.客户端感知到服务端断开连接，则立即使用新连接收发消息，完成重定向
### 9.心跳确认

> 1.客户端每5分钟+30s随机发送一个心跳消息过来，可以是上行消息的一个空消息体作为心跳 
> 2.网关机解析后，调用state server将消息转发过去
> 3.State server会得知心跳中的一些统计信息，然后重置计时器，并回复ack。
> 4.如果此连接上有其他任意消息发送，都会重置心跳计时器，同时客户端也会重置心态计时器。
> 5.尽可能的减少心跳包的数量，减少网络负载

### 10.超时重传

> 1.如果重传计时器到期，会通知state server，state server会根据飞行队列中保存的消息顺序依次重发
> 2.每次重发后：重传计时器都会被重置

### 11.消息回执

> 1.state server收到业务server的异步写入rpc成功后，就会返回给网关机一个ack信令。 
> 2.网关机立即回复给发送客户端消息确认即可

### 12.连接回收

> 1.客户端断开连接或者重连超时后网关机回收自身内存状态，session到did，did到conn
> 2.再通知state server对各种定时器，重传队列资源进行回收 
> 3.State server还会通知业务server，通知某个设备已经下线

