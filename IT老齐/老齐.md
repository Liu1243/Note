## 75 高可用架构如何避免单点，经典方案Keepalived＋VIP用了都说好！
Keepalived+VIP是什么？
基于Keepalived的Nginx高可用架构的落地配置？
Keepalived的VIP抢占问题与脑裂问题？

规避单点是HA架构最基本的考量

Keepalived是Linux2轻量级别的高可用解决方案。
Keepalived主要是通过虚拟路由冗余(VRRP)来实现高可用功能，Keepalived部署和使用非常的简单，所有配置只需要一个配置文件即可以完成。
虚拟路由冗余协议(Virtual Router Redundancy Protocol,简称VRRP)是由IETF提出的解决局域网中配置静态网关出现单点失效现象的路由协议

VIP(虚拟IP)是虚拟的IP,与实际网卡绑定的的P地址不同，VIP在内网中被动态的映射到不同的MAC地址上，也就是映射到不同的机器设备上，Keepalived通过"心跳机制”监测服务器状态，Master主节点宕机则自动将"IP漂移”到Backup备机上实现高可用。
==通过VIP隐藏实际IP，Keepalived底层的IP漂移技术完成HA==
![](IT%E8%80%81%E9%BD%90/attachments/1bc610cdf13c1385c34f4e2412003714_MD5.jpeg)
==如果因为Keepalived挂掉==，master无法发送心跳包，Backup自动升级为Master，产生IP飘逸设置虚拟IP为.5，继续提供服务
当master恢复后，Keepalived自动IP漂移回原master，新mater降级回backup

基于VIP的Nginx高可用方案
![](IT%E8%80%81%E9%BD%90/attachments/c007266fe8aef5ed8dc16b7d352af648_MD5.jpeg)
如果Keepalived没挂，结点上的Nginx挂掉，还可以发送心跳包，怎么办呢？
![](IT%E8%80%81%E9%BD%90/attachments/2c23c911f5d02a96285dfce8f6a6a9cb_MD5.jpeg)
新增nginx_check.sh脚本，如果nginx服务挂掉，主动杀掉keepalived进程。 

但常规的配置两个nginx只有一个提供服务，可以配置为互为主备
![](IT%E8%80%81%E9%BD%90/attachments/c68dbb863c635a435add3f77c2c8d2bf_MD5.jpeg)
这里DNS是单点，但不用考虑DNS的高可用问题，通常DNS没有单点故障问题。

通常情况下，原master挂掉后恢复，会ip漂移回原master，但这中间会存在一段时间的不可用。可以使用nopreempt非抢占模式，原master恢复后降级为从属结点。

还有一种情况会发生脑裂：主从之间的vrrp心跳包因为网络问题不可达，导致主和从都认为自己是主节点。
![](IT%E8%80%81%E9%BD%90/attachments/8a3d455bd188654b0e9e7248b105dcab_MD5.jpeg)
pkill -9是强制停止，不会清除使用的虚拟ip，所以需要使用pkill正常结束

## 76 自己一次脑瘫引发的XSS漏洞，导致上千客户泄密
未对用户输入的信息进行转义，导致xss；注意转义逻辑在服务端做；可以使用Spring的HtmlUtils的htmlEscape方法进行转义。

## 77 几张图讲明白RocketMQ高可用方案
RocketMQ有哪些角色
RocketMQ消息生产消费流程
Broker主挂了RocketMQ怎么办
Broker主从都挂了RocketMQ怎么办
NameServer挂了RocketMQ怎么办
同步复制与异步复制之间的区别与应用场景

![](IT%E8%80%81%E9%BD%90/attachments/c67db46eb39f4783ddb9e23c015b05f4_MD5.jpeg)
每一个Broker就是一个服务器
![](IT%E8%80%81%E9%BD%90/attachments/d0cb0a7c036ca804c3e4f71bc7533fd5_MD5.jpeg)
NameServer就是注册中心
![](IT%E8%80%81%E9%BD%90/attachments/e5b37ad4b41cb98f4ac52fb18a04d68c_MD5.jpeg)
2-3NameServer防止单点故障，主Broker提供写入和读取，从Broker只提供读取；主从Broker通过日志同步；主Broker的数据不重叠
a主挂掉，a主停止写入服务，consumer从a从拉数据，slave-a不会升级为master-a，同步复制不会丢数据，异步复制不会丢数据
![](IT%E8%80%81%E9%BD%90/attachments/d58a88eace695f0033c8b1271741bf50_MD5.jpeg)
a主挂后，Producer重试发送到b主

a主a从都挂后，a挤压的数据无法获取，但已经持久化不会丢失；
![](IT%E8%80%81%E9%BD%90/attachments/5bb2591b039edd63040d3f526e6b3364_MD5.jpeg)