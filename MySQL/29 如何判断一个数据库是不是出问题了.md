一主一备的双M架构里，主库切换只需要把客户端流量切换到备库；而在一主多从架构里，主备切换除了要把客户端流量切到备库外，还需要把从库接到新主库上。
主备切换有两种场景，一种是主动切换，一种是被动切换。而其中被动切换，往往是因为主库出问题了，由HA系统发起的。
那么怎么判断一个主库出问题了？

## select 1判断
实际上，select 1成功返回，只能说明这个库的进程还在，并不能说明主库没问题。
`set global innodb_thread_concurrency=3;`
![](MySQL/attachments/6de27db554ccb773a1b0b2b8136b3d07_MD5.jpeg)
设置innodb_thread_concurrency参数的目的是，控制InnoDB的并发线程上限。
前三个session 中的sleep(100)，使得这三个语句都处于“执行”状态，以此来模拟大查询。session D里面，select 1是能执行成功的，但是查询表t的语句会被堵住。说明使用select 1来检测实例是否正常的话，是检测不出来的。
在InnoDB中，innodb_thread_concurrency这个参数的默认值是0，表示不限制并发线程数量。但是，不限制并发线程数肯定是不行的。因为，一个机器的CPU核数有限，线程全冲进来，上下文切换的成本就会太高。
所以，通常情况下，我们建议把innodb_thread_concurrency设置为64~128之间的值。
**并发线程和并发查询**
并发连接和并发查询，并不是同一个概念。你在show processlist的结果里，看到的几千个连接，指的就是并发连接。而“当前正在执行”的语句，才是我们所说的并发查询。
并发连接数达到几千个影响并不大，就是多占一些内存而已。我们应该关注的是并发查询，因为并发查询太高才是CPU杀手。这也是为什么我们需要设置innodb_thread_concurrency参数的原因。
**线程进入锁等待以后，并发线程的计数会减一**。
MySQL这样设计是非常有意义的。因为，进入锁等待的线程已经不吃CPU了；更重要的是，必须这么设计，才能避免整个系统锁死。

## 查表判断
为了能够检测InnoDB并发线程数过多导致的系统不可用情况，我们需要找一个访问InnoDB的场景。一般的做法是，在系统库（mysql库）里创建一个表，比如命名为health_check，里面只放一行数据，然后定期执行：
`select * from mysql.health_check`
使用这个方法，我们可以检测出由于并发线程过多导致的数据库不可用的情况。
但是如果binlog所在的磁盘空间使用率达到100%，所有的update以及commit会被堵住，但是还是可以正常读数据。

## 更新判断
既然要更新，就要放个有意义的字段，常见做法是放一个timestamp字段，用来表示最后一次执行检测的时间。
`update mysql.health_check set t_modified=now();`
节点可用性的检测都应该包含主库和备库。如果用更新来检测主库的话，那么备库也要进行更新检测。
问题是在双M架构中，binlog在主库备库之间会相互转发，更新出现行冲突，导致主备同步停止。
为了让主备之间的更新不产生冲突，我们可以在mysql.health_check表上存入多行数据，并用A、B的server_id做主键。
==“判定慢”一直是让DBA头疼的问题。==
**更新语句，如果失败或者超时，就可以发起主备切换了，为什么还会有判定慢的问题呢？**
所有的检测逻辑都需要一个超时时间。设想一个日志盘，IO利用率已经是100%了，整个系统的响应非常慢，需要主备切换，但是检测的update语句在超时时间内返回给检测系统，得到了“系统正常”的结论。
之所以会出现这个现象，根本原因是我们上面说的所有方法，都是基于外部检测的。外部检测天然有一个问题，就是随机性。

## 内部统计
MySQL 5.6版本以后提供的performance_schema库，就在file_summary_by_event_name表里统计了每次IO请求的时间。
![](MySQL/attachments/5b7083307c4e5b32b8228e30a6cf74a2_MD5.jpeg)
如果打开所有的performance_schema项，性能大概会下降10%左右。所以，我建议你只打开自己需要的项进行统计。你可以通过下面的方法打开或者关闭某个具体项的统计。
可以通过MAX_TIMER的值来判断数据库是否出问题了。比如，你可以设定阈值，单次IO请求时间超过200毫秒属于异常。
发现异常后，取到你需要的信息，然后把之前的统计信息清空，这样在后面的监控中，再次出现这个异常，加入监控累计值。

## 小结
优先考虑update系统表，配合增加检测performance_schema的信息。

## 问题
业务系统一般也有高可用的需求，在你开发和维护过的服务中，你是怎么判断服务有没有出问题的呢？
答案：
- 服务状态和服务质量的监控。服务状态的监控使用外部系统实现；服务质量的监控，通过接口的响应时间统计。
- 使用healthCheck检测
- 按照监控的对象，将监控分成了基础监控（硬盘、CPU、网络、内存）、服务监控（jvm、服务断开、超时监控）和业务监控（业务流程是否出现问题）。