## 分布式系统的冰与火
使用分布式系统的原因：
- 增大系统容量：多台机器应对大规模应用场景；垂直或水平拆分业务，变成一个分布式架构。

|特性|**垂直拆分**|**水平拆分**|
|---|---|---|
|拆分维度|按业务功能模块|按数据维度（用户/时间/哈希）|
|解决问题|**业务复杂度 / 模块解耦**|**单表/单库性能瓶颈**|
|典型场景|电商系统：用户、订单、支付|高并发大数据量：订单表分库分表|
|数据库|多个业务独立库|同业务多库分片|
|复杂性|服务间通信、事务一致性|跨分片查询、分布式事务|
|优点|易扩展、业务清晰、团队协作好|数据水平扩展，支持海量数据|
|缺点|依赖多、运维复杂|路由复杂、聚合查询难|
- 加强系统可用：通过分布式架构来冗余系统以消除单点故障，从而提高系统的可用性。

单体应用和分布式架构的优缺点：
![](%E5%B7%A6%E8%80%B3%E5%90%AC%E9%A3%8E/attachments/eb90768e579bb2971775f1c8c52d0eb2_MD5.jpeg)
分布式系统架构的难点在于系统设计，以及管理和运维。

### 分布式系统的发展
SOA-基于服务的架构
![](%E5%B7%A6%E8%80%B3%E5%90%AC%E9%A3%8E/attachments/66922104f9bc640d32127429efbcacbd_MD5.jpeg)
- 20 世纪 90 年代前，是单体架构，软件模块高度耦合。
- 而 2000 年左右出现了比较松耦合的 SOA 架构，这个架构需要一个标准的协议或是中间件来联动其它相关联的服务（如 ESB）。其实是IoC和DIP设计思想在架构中的实践。
- 而 2010 年后，出现了微服务架构，这个架构更为松耦合。每个微服务自包含，服务的整合需要服务编排。

SOA和微服务的区别：

|对比点|SOA|微服务|
|---|---|---|
|核心思想|服务化|服务更小粒度化|
|通信方式|ESB 统一调度|轻量级 RPC/REST/消息队列|
|服务治理|中心化（依赖 ESB）|去中心化（服务发现+网关）|
|粒度|粗粒度服务|小而自治的服务|
|技术依赖|SOAP、WS-* 协议为主|REST/HTTP、gRPC 等|
|演进关系|微服务是 SOA 的进化版|来源于 SOA，但更轻量灵活|

编排和组织引擎可以是工作流引擎，也可以是网关。微服务在集成测试、运维和服务管理方面比较麻烦，需要一个比较好的微服务PaaS平台，就像Spring Cloud提供各种配置服务、服务发现等，还有K8S提供的部署和调度方式。

## 从亚马逊的实践谈分布式系统的难点
1. 分布式服务的架构需要分布式的团队架构。一个服务不超过16人（Two Pizza Team）负责，从前端到数据，从需求到上线运维，==按职责分工，而不是技能分工==
2. 分布式服务查错不容易。一旦出现比较严重的故障，需要整体查错。
3. 没有专职的测试人员，也没有专职的运维人员，开发人员做所有的事情。
4. 运维优先，崇尚简化和自动化。DevOps
5. 内部服务和外部服务一致。内部系统的服务随时都可以开放出来

### 分布式系统中需要注意的问题
问题1：异构系统的不标准问题
这主要表现在：
- 软件和应用不标准。
- 通讯协议不标准。
- 数据格式不标准。
- 开发和运维的过程和方法不标准。

好的配置管理：应该分成三层：底层和操作系统相关，中间层和中间件相关，最上面和业务应用相关。底层和中间层是不能让用户灵活修改的，而是只让用户选择。

问题2：系统架构中的服务依赖性问题
分布式架构下，服务是会有依赖的，一个服务依赖链上的某个服务挂掉了，可能会导致出现“多米诺骨牌”效应。
- 如果非关键业务被关键业务所依赖，会导致非关键业务变成一个关键业务。
- 服务依赖链中，出现“木桶短板效应”——整个 SLA 由最差的那个服务所决定。
这就是服务治理的内容，需要我们定义出服务的关键程度，还需要定义关键业务或服务调用的主要路径。

这里需要注意的是，很多分布式架构在应用层上做到了业务隔离，然而，在数据库结点上并没有。数据库方面也需要做出相应的隔离。我们不但要拆分服务，还要为每个服务拆分相应的数据库。

问题3：故障发生的概率更大
分布式系统虽然故障的影响面可以被隔离，但是由于机器和服务多，出故障的频率也会多。
- 出现故障不可怕，故障恢复时间过长才可怕。
- 出现故障不可怕，故障影响面过大才可怕。

问题4：多层架构的运维复杂度更大
我们可以把系统分成四层：基础层、平台层、应用层和接入层。
- 基础层就是我们的机器、网络和存储设备等。
- 平台层就是我们的中间件层，Tomcat、MySQL、Redis、Kafka 之类的软件。
- 应用层就是我们的业务软件，比如，各种功能的服务。
- 接入层就是接入用户请求的网关、负载均衡或是 CDN、DNS 这样的东西。
对于这四层，我们需要知道：
- 任何一层的问题都会导致整体的问题；
- 没有统一的视图和管理，导致运维被割裂开来，造成更大的复杂度。
很多公司按照技能分工，他们按照技能把技术团队分为产品开发、中间件开发、业务运维、系统运维等子团队。导致没有统一的运维视图，不知道一个服务调用是如何经过每一个服务和资源，也就导致在出现故障时要花大量的时间在沟通和定位问题上。

==分工不是问题，问题是分工后的协作是否统一和规范。==

## 分布式系统的技术栈
构建分布式系统的目的是增加系统容量，提高系统的可用性。转换为技术方面，就是完成：
- 大流量处理。通过集群技术把大规模并发请求的负载分散到不同的机器上。
- 关键业务保护。提高后台服务的可用性，把故障隔离起来阻止多米诺骨牌效应（雪崩效应）。如果流量过大，需要对业务降级，以保护关键业务流转。
一是提高整体架构的吞吐量，服务更多的并发和流量，二是为了提高系统的稳定性，让系统的可用性更高。

提高架构的性能
常用技术：
![](%E5%B7%A6%E8%80%B3%E5%90%AC%E9%A3%8E/attachments/255b606466f27cb76fdb774da0f5b53f_MD5.jpeg)
- 缓存系统。加入缓存系统，可以有效地提高系统的访问能力。从前端的浏览器，到网络，再到后端的服务，底层的数据库、文件系统、硬盘和 CPU，全都有缓存，这是提高快速访问能力最有效的手段。对于分布式系统下的缓存系统，需要的是一个缓存集群。这其中需要一个 Proxy 来做缓存的分片和路由。
- 负载均衡系统。负载均衡系统是水平扩展的关键技术，它可以使用多台机器来共同分担一部分流量请求。
- 异步调用。异步系统主要通过消息队列来对请求做排队处理，这样可以把前端的请求的峰值给“削平”了，而后端通过自己能够处理的速度来处理请求。这样可以增加系统的吞吐量，但是实时性就差很多了。同时，还会引入消息丢失的问题，所以要对消息做持久化，这会造成“有状态”的结点，从而增加了服务调度的难度。
- 数据分区和数据镜像。数据分区是把数据按一定的方式分成多个区（比如通过地理位置），不同的数据区来分担不同区的流量。这需要一个数据路由的中间件，会导致跨库的 Join 和跨库的事务非常复杂。而数据镜像是把一个数据库镜像成多份一样的数据，这样就不需要数据路由的中间件了。你可以在任意结点上进行读写，内部会自行同步数据。然而，数据镜像中最大的问题就是数据的一致性问题。
初期会使用读写分离的数据镜像模式，后期采用分库分表的方式。

提高架构的稳定性
![](%E5%B7%A6%E8%80%B3%E5%90%AC%E9%A3%8E/attachments/cd0eb32c953e2b7a616cd78b5396e7c8_MD5.jpeg)
- 服务拆分。服务拆分主要有两个目的：一是为了隔离故障，二是为了重用服务模块。但服务拆分完之后，会引入服务调用间的依赖问题。
- 服务冗余。服务冗余是为了去除单点故障，并可以支持服务的弹性伸缩，以及故障迁移。然而，对于一些有状态的服务来说，冗余这些有状态的服务带来了更高的复杂性。其中一个是弹性伸缩时，需要考虑数据的复制或是重新分片，迁移的时候还要迁移数据到其它机器上。
- 限流降级。当系统实在扛不住压力时，只能通过限流或者功能降级的方式来停掉一部分服务，或是拒绝一部分用户，以确保整个架构不会挂掉。这些技术属于保护措施。
- 高可用架构。通常来说高可用架构是从冗余架构的角度来保障可用性。比如，多租户隔离，灾备多活，或是数据可以在其中复制保持一致性的集群。总之，就是为了不出单点故障。
- 高可用运维。高可用运维指的是 DevOps 中的 CI/CD（持续集成 / 持续部署）。一个良好的运维应该是一条很流畅的软件发布管线，其中做了足够的自动化测试，还可以做相应的灰度发布，以及对线上系统的自动化控制。这样，可以做到“计划内”或是“非计划内”的宕机事件的时长最短。

分布式系统的关键技术
服务治理。服务拆分、服务调用、服务发现、服务依赖、服务的关键度定义……服务治理的最大意义是需要把服务间的依赖关系、服务调用链，以及关键的服务给梳理出来，并对这些服务进行性能和可用性方面的管理。
架构软件管理。服务之间有依赖，而且有兼容性问题，所以，整体服务所形成的架构需要有架构版本管理、整体架构的生命周期管理，以及对服务的编排、聚合、事务处理等服务调度功能。
DevOps。分布式系统可以更为快速地更新服务，但是对于服务的测试和部署都会是挑战。所以，还需要 DevOps 的全流程，其中包括环境构建、持续集成、持续部署等。
自动化运维。有了 DevOps 后，我们就可以对服务进行自动伸缩、故障迁移、配置管理、状态管理等一系列的自动化运维技术了。
资源调度管理。应用层的自动化运维需要基础层的调度支持，也就是云计算 IaaS 层的计算、存储、网络等资源调度、隔离和管理。
整体架构监控。如果没有一个好的监控系统，那么自动化运维和资源调度管理只可能成为一个泡影，因为监控系统是你的眼睛。没有眼睛，没有数据，就无法进行高效运维。所以说，监控是非常重要的部分。这里的监控需要对三层系统（应用层、中间件层、基础层）进行监控。
流量控制。最后是我们的流量控制，负载均衡、服务路由、熔断、降级、限流等和流量相关的调度都会在这里，包括灰度发布之类的功能也在这里。

Docker和K8S解决了上述大部分问题。

分布式系统的“纲”
分布式系统有5个关键句技术：
- 全栈系统监控；
- 服务 / 资源调度；
- 流量调度；
- 状态 / 数据调度；
- 开发和运维的自动化。
开发和运维的自动化，是需要把前四项都做到了，才有可能实现的。
![](%E5%B7%A6%E8%80%B3%E5%90%AC%E9%A3%8E/attachments/2a54f237bbfc3d398b31d55c6d210d2d_MD5.jpeg)

## 分布式系统关键技术：全栈监控
